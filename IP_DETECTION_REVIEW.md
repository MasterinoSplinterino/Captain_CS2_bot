# üîç IP Detection Architecture Review

## ‚úÖ –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è IPv4**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ç–µ—Ç–æ–≤ (0-255) –≤–æ –≤—Å–µ—Ö —Ç—Ä—ë—Ö –º–µ—Å—Ç–∞—Ö:
  - `ip-detector/public_ip_detector.sh` 
  - `scripts/public_ip_entrypoint.sh` (–æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
  - `scripts/public_ip_entrypoint.sh` (–≤–Ω—É—Ç—Ä–∏ dig shim)
- –¢–µ–ø–µ—Ä—å `999.999.999.999` –Ω–µ –ø—Ä–æ–π–¥—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫—É

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å BusyBox sed**
- –£–±—Ä–∞–Ω—ã `sed -i` (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Alpine)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `sed ... > tmp && mv tmp` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –∑–∞–º–µ–Ω—ã

### 3. **Dig shim —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤—Å–µ–≥–¥–∞**
- –†–∞–Ω—å—à–µ: —Å–æ–∑–¥–∞–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `/shared/public_ip.txt` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –¢–µ–ø–µ—Ä—å: —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–ø—É—Å–∫–µ, —á—Ç–æ–±—ã `install_docker.sh` –Ω–µ —É–ø–∞–ª –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä–µ

## üìù –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   public-ip      ‚îÇ  –î–µ—Ç–µ–∫—Ç–æ—Ä (Alpine + dig/curl)
‚îÇ   –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä      ‚îÇ  –û–±–Ω–æ–≤–ª—è–µ—Ç /shared/public_ip.txt –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ –ø–∏—à–µ—Ç –≤ volume
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ public-ip-cache  ‚îÇ  Named volume (–æ–±—â–∏–π)
‚îÇ    /shared/      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ —á–∏—Ç–∞–µ—Ç
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚ñº         ‚ñº              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  cs2   ‚îÇ ‚îÇ bot  ‚îÇ  ‚îÇentrypoint.sh ‚îÇ
‚îÇ        ‚îÇ ‚îÇ      ‚îÇ  ‚îÇ + dig shim   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω dig shim?

Upstream —Å–∫—Ä–∏–ø—Ç `install_docker.sh` –≤ –æ–±—Ä–∞–∑–µ `ghcr.io/kus/cs2-modded-server` **–∂—ë—Å—Ç–∫–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω** —Å –≤—ã–∑–æ–≤–∞–º–∏:
```bash
dig +short myip.opendns.com @resolver1.opendns.com
dig +short TXT o-o.myaddr.l.google.com @ns1.google.com
```

–ï—Å–ª–∏ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –ø–∞–¥–∞—é—Ç ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç. Shim –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —ç—Ç–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞** –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç IP –∏–∑ –∫—ç—à–∞, –æ—Å—Ç–∞–ª—å–Ω—ã–µ dig-–∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É –±–∏–Ω–∞—Ä–Ω–∏–∫—É.

## üí° –ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ—â–µ?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –§–æ—Ä–∫–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ ‚ùå
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –≤—ã—Å–æ–∫–∞—è  
**–ü–ª—é—Å—ã:** –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å  
**–ú–∏–Ω—É—Å—ã:** –ù—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–≤–æ—é —Å–±–æ—Ä–∫—É, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è upstream –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–µ—Ä–µ–¥–∞—Ç—å PUBLIC_IP —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ‚úÖ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```yaml
environment:
  - PUBLIC_IP=${PUBLIC_IP:-auto}
  - PUBLIC_IP_FETCH=0  # –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
```
–ü—Ä–æ–±–ª–µ–º–∞: upstream –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç `PUBLIC_IP_FETCH=0` –∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `dig`.

### –í–∞—Ä–∏–∞–Ω—Ç 3: Volume overlay –¥–ª—è install_docker.sh ‚ùå
–ó–∞–º–µ–Ω–∏—Ç—å `/home/cs2-modded-server/install_docker.sh` —Å–≤–æ–∏–º —á–µ—Ä–µ–∑ volume mount.  
**–ú–∏–Ω—É—Å—ã:** –•—Ä—É–ø–∫–æ, —Å–ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±—Ä–∞–∑–∞

### –í–∞—Ä–∏–∞–Ω—Ç 4: –£–±—Ä–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ ‚ùå
–í–µ—Ä–Ω—É—Ç—å –ª–æ–≥–∏–∫—É –≤ entrypoint.  
**–ú–∏–Ω—É—Å—ã:** CS2 –æ–ø—è—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ—Ç–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –Ω–µ—Ç –∫—ç—à–∞ –¥–ª—è –±–æ—Ç–∞

## ‚ú® –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ

–ü—Ä–∏—á–∏–Ω—ã:
1. **–ò–∑–æ–ª—è—Ü–∏—è –æ—Ç–∫–∞–∑–æ–≤** ‚Äî –¥–µ—Ç–µ–∫—Ç–æ—Ä –ø–∞–¥–∞–µ—Ç ‚Üí —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º IP
2. **–û–±—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫** ‚Äî –±–æ—Ç –∏ —Å–µ—Ä–≤–µ—Ä —á–∏—Ç–∞—é—Ç –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ
3. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ñ–æ—Ä–∫–∞ upstream –æ–±—Ä–∞–∑–∞
4. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** ‚Äî –ª—é–±—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å `/shared/public_ip.json`

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. Health check –¥–ª—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞
```yaml
public-ip:
  healthcheck:
    test: ["CMD", "test", "-f", "/shared/public_ip.txt"]
    interval: 30s
    timeout: 5s
    retries: 3
```

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
```bash
# –í public_ip_detector.sh
exec > >(tee -a /shared/detector.log)
exec 2>&1
```

### 3. –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
```bash
# –í –¥–µ—Ç–µ–∫—Ç–æ—Ä–µ –¥–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫
echo "public_ip_last_update $(date +%s)" > /shared/metrics.prom
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏

| –ü–æ–¥—Ö–æ–¥ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|-----------|------------|---------------|--------------|
| **–¢–µ–∫—É—â–∏–π (–¥–µ—Ç–µ–∫—Ç–æ—Ä + shim)** | –°—Ä–µ–¥–Ω—è—è | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ–º** |
| –§–æ—Ä–∫ –æ–±—Ä–∞–∑–∞ | –í—ã—Å–æ–∫–∞—è | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚ùå –û–≤–µ—Ä–∫–∏–ª |
| –¢–æ–ª—å–∫–æ entrypoint | –ù–∏–∑–∫–∞—è | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚ùå –ù–µ—Ç –∏–∑–æ–ª—è—Ü–∏–∏ |
| HTTP –±–µ–∑ dig | –ù–∏–∑–∫–∞—è | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚ùå Upstream —Ç—Ä–µ–±—É–µ—Ç dig |

## üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ:**
   ```bash
   docker compose -f docker-compose.prod.yml build
   docker compose -f docker-compose.prod.yml up -d
   docker logs cs2-public-ip
   docker logs cs2-server | grep -i "public ip"
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ—Ç–∞:**
   - `/start ‚Üí Status` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å IP –∏–∑ –∫—ç—à–∞
   - –ö–æ–º–∞–Ω–¥–∞ `connect` –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:**
   ```bash
   # –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞
   docker logs -f cs2-public-ip
   
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
   docker exec cs2-public-ip cat /shared/public_ip.txt
   ```

## üìû –í–æ–ø—Ä–æ—Å—ã?

- **Q:** –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π curl –≤ entrypoint?  
  **A:** Upstream —Å–∫—Ä–∏–ø—Ç –∂—ë—Å—Ç–∫–æ —Ç—Ä–µ–±—É–µ—Ç `dig`, –∞ –º—ã –Ω–µ –º–æ–∂–µ–º –µ–≥–æ –ø–∞—Ç—á–∏—Ç—å –±–µ–∑ —Ñ–æ—Ä–∫–∞.

- **Q:** –ú–æ–∂–Ω–æ –ª–∏ —É–±—Ä–∞—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–æ–≤—Å–µ–º?  
  **A:** –î–∞, –Ω–æ —Ç–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–µ—Ç–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –Ω–µ –±—É–¥–µ—Ç –∫—ç—à–∞ –¥–ª—è –±–æ—Ç–∞.

- **Q:** –ó–∞—á–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–∫—Ç–µ—Ç—ã, –µ—Å–ª–∏ ipaddress.IPv4Address –≤ Python —ç—Ç–æ –¥–µ–ª–∞–µ—Ç?  
  **A:** Bash-—Å–∫—Ä–∏–ø—Ç—ã –Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Python, –∏–º –Ω—É–∂–Ω–∞ —Å–≤–æ—è –≤–∞–ª–∏–¥–∞—Ü–∏—è.
