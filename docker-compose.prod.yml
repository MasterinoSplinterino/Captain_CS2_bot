services:
  cs2:
    image: ghcr.io/kus/cs2-modded-server:latest
    container_name: cs2-server
    restart: unless-stopped
    network_mode: host
    entrypoint:
      - /bin/bash
      - /scripts/public_ip_entrypoint.sh
    environment:
      - SRCDS_TOKEN=${CS2_GSLT_TOKEN}
      - SRCDS_PW=${CS2_PASSWORD}
      - SRCDS_RCONPW=${RCON_PASSWORD}
      - RCON_PASSWORD=${RCON_PASSWORD}
      - SRCDS_HOSTNAME=${CS2_SERVERNAME}
      - STEAM_API_KEY=${STEAM_API_KEY}
      - LAN=0
      - IP=0.0.0.0
      - PORT=27015
      - SRCDS_IP=0.0.0.0
      - SRCDS_PORT=27015
      - PUBLIC_IP=${PUBLIC_IP:-auto}
      - CS2_IP=${PUBLIC_IP:-auto}
      - PUBLIC_IP_FILE=/shared/public_ip.txt
      # Friendly Fire Settings
      - CS2_CFG_mp_friendlyfire=1
      - CS2_CFG_ff_damage_reduction_bullets=0.33
      - CS2_CFG_ff_damage_reduction_grenade=0.85
      - CS2_CFG_ff_damage_reduction_grenade_self=1
      - CS2_CFG_ff_damage_reduction_other=0.4
      # Performance Optimizations
      - CS2_CFG_sv_maxrate=0
      - CS2_CFG_sv_minrate=196608
      - CS2_CFG_sv_maxupdaterate=128
      - CS2_CFG_sv_minupdaterate=64
      - CS2_CFG_sv_mincmdrate=64
      - CS2_CFG_sv_maxcmdrate=128
      # Network Performance
      - CS2_CFG_net_maxcleartime=0.001
      - CS2_CFG_sv_parallel_packentities=1
      - CS2_CFG_sv_parallel_sendsnapshot=1
      # Server Performance
      - CS2_CFG_host_thread_mode=2
      - CS2_CFG_sv_clockcorrection_msecs=15
      - CS2_CFG_sv_max_queries_sec_global=60
      - CS2_CFG_sv_max_queries_window=60
      - CS2_CFG_sv_max_queries_sec=5
      # Reduce prediction errors
      - CS2_CFG_sv_lagcompensation_teleport_dist=64
      - CS2_CFG_sv_maxunlag=0.4
    volumes:
      # Mount the data from the host path where you copied the USB files
      - /opt/cs2-data:/home/steam/cs2/
      # Inject custom entrypoint that resolves PUBLIC_IP before server boot
      - ./scripts/public_ip_entrypoint.sh:/scripts/public_ip_entrypoint.sh:ro
      - public-ip-cache:/shared
    stdin_open: true
    tty: true
    # Performance optimizations
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4g
        reservations:
          cpus: '2'
          memory: 2g
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 65536
        hard: 65536
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_NICE
      - SYS_RESOURCE
    depends_on:
      - public-ip

  bot:
    # In Dokploy, you might need to build this from a git repo or push the image to a registry.
    # If using "docker-compose" build type in Dokploy, it can build from context if the repo is connected.
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: cs2-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      - RCON_HOST=172.17.0.1
      - RCON_PORT=27015
      - RCON_PASSWORD=${RCON_PASSWORD}
      - CS2_PASSWORD=${CS2_PASSWORD}
      - CS2_SERVERNAME=${CS2_SERVERNAME}
      - CS2_IP=${CS2_IP}
      - CS2_DOMAIN=${CS2_DOMAIN}
      - PUBLIC_IP_FILE=/shared/public_ip.txt
    dns:
      - 8.8.8.8
      - 1.1.1.1
    volumes:
      # Mount the same data volume so the bot can access logs/files if needed
      - /opt/cs2-data:/cs2-data
      # Mount firewall setup scripts (read-only)
      - ./setup_firewall.sh:/scripts/setup_firewall.sh:ro
      - ./check_ports.sh:/scripts/check_ports.sh:ro
      - public-ip-cache:/shared:ro
    # Optional: Enable if you want the bot to auto-configure firewall (requires privileged mode)
    # WARNING: Only enable this if you trust the bot code completely
    # privileged: true
    # pid: "host"
    depends_on:
      - public-ip

  public-ip:
    build:
      context: ./ip-detector
      dockerfile: Dockerfile
    container_name: cs2-public-ip
    restart: unless-stopped
    environment:
      - PUBLIC_IP_REFRESH_SECONDS=60
      - PUBLIC_IP_PORT=27015
    volumes:
      - public-ip-cache:/shared

  # Playit.gg Tunnel for Game Traffic (UDP)
  # 1. Start the stack.
  # 2. Check logs: docker logs cs2-playit
  # 3. Copy the claim URL and visit it in your browser.
  # 4. Create a UDP tunnel pointing to: cs2:27015
  playit:
    image: ghcr.io/playit-cloud/playit-agent:latest
    container_name: cs2-playit
    restart: unless-stopped
    environment:
      - SECRET_KEY=${PLAYIT_SECRET} # Optional: Add this to Dokploy env vars AFTER you claim the agent to persist it easily
    volumes:
      - playit-data:/etc/playit # Persist configuration
    depends_on:
      - cs2
  # Optional: Cloudflare Tunnel for SSH/Management access
  # This does NOT tunnel the game UDP traffic for players, but allows you to SSH into the container/host
  # or access internal web services if you add them.
  # tunnel:
  #   image: cloudflare/cloudflared:latest
  #   container_name: cs2-tunnel
  #   restart: unless-stopped
  #   command: tunnel run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}

volumes:
  playit-data:
  public-ip-cache:
